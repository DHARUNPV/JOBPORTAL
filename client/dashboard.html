<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Job Portal Dashboard</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .job-card { border: 1px solid #ccc; padding: 10px; margin: 10px 0; border-radius: 5px; }
    #applicationsSection { display:none; border:1px solid #aaa; padding:15px; margin-top:20px; }
    .top-right-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      padding: 8px 12px;
      border: none;
      border-radius: 6px;
      background: #007bff;
      color: white;
      cursor: pointer;
    }
    .top-right-btn:hover { background: #0056b3; }
  </style>
</head>
<body>
  <h1>Dashboard</h1>
  <button id="logoutBtn">Logout</button>
  <button id="viewProfileBtn" class="top-right-btn">My Profile</button>

  <!-- Profile Section -->
  <div id="profileSection" style="display:none; margin-top:60px; border:1px solid #ccc; padding:15px;">
    <h2>My Profile</h2>

    <!-- Edit Profile Form -->
    <form id="profileForm">
      <input type="text" id="profileName" placeholder="Full Name" required><br>
      <input type="text" id="profilePhone" placeholder="Phone"><br>
      <input type="text" id="profileSkills" placeholder="Skills"><br>
      <input type="number" id="profileExperience" placeholder="Experience (years)"><br>
      <input type="text" id="profileEducation" placeholder="Education"><br>
      <button type="submit">Save Profile</button>
    </form>

    <!-- View Profile -->
    <div id="viewProfile" style="display:none; margin-top:15px;">
      <p><strong>Name:</strong> <span id="pName"></span></p>
      <p><strong>Email:</strong> <span id="pEmail"></span></p>
      <p><strong>Phone:</strong> <span id="pPhone"></span></p>
      <p><strong>Skills:</strong> <span id="pSkills"></span></p>
      <p><strong>Experience:</strong> <span id="pExperience"></span> years</p>
      <p><strong>Education:</strong> <span id="pEducation"></span></p>
      <button id="editProfileBtn">Edit Profile</button>
    </div>
  </div>

  <hr>

  <!-- Search + Filter -->
  <section>
    <h2>Find Jobs</h2>
    <input type="text" id="searchInput" placeholder="Search by job title or keyword">
    <input type="text" id="locationFilter" placeholder="Filter by location">
    <button onclick="filterJobs()">Search</button>
  </section>

  <!-- Job Listings -->
  <section>
    <h2>Available Jobs</h2>
    <div id="jobsList"></div>
    <button id="viewApplicationsBtn" style="margin-top:15px;">My Applications</button>
  </section>

  <!-- My Applications Section -->
  <section id="applicationsSection">
    <h2>My Applications</h2>
    <div id="applicationsList"></div>
    <button onclick="closeApplications()">Close</button>
  </section>

  <script>
    const API_BASE = 'https://jobportal-2knb.onrender.com/api';
    let allJobs = []; 
    let currentUserEmail = localStorage.getItem("currentUser");

    document.addEventListener('DOMContentLoaded', () => {
      const token = localStorage.getItem('token');
      if (!token || !currentUserEmail) window.location.href = 'login.html';

      // Logout
      document.getElementById('logoutBtn').addEventListener('click', () => {
        localStorage.removeItem('token');
        localStorage.removeItem('currentUser');
        window.location.href = 'login.html';
      });

      // === PROFILE SECTION ===
      const viewProfileBtn = document.getElementById("viewProfileBtn");
      const profileSection = document.getElementById("profileSection");
      const profileForm = document.getElementById("profileForm");
      const viewProfile = document.getElementById("viewProfile");

      const pName = document.getElementById("pName");
      const pEmail = document.getElementById("pEmail");
      const pPhone = document.getElementById("pPhone");
      const pSkills = document.getElementById("pSkills");
      const pExperience = document.getElementById("pExperience");
      const pEducation = document.getElementById("pEducation");

      viewProfileBtn.addEventListener("click", async () => {
        profileSection.style.display = "block";

        try {
          const res = await fetch(`${API_BASE}/users/profile`, {
            method: 'GET',
            headers: { 'Authorization': `Bearer ${token}` }
          });
          const data = await res.json();

          if (res.ok) {
            pName.textContent = data.name || "";
            pEmail.textContent = data.email || currentUserEmail;
            pPhone.textContent = data.phone || "Not provided";
            pSkills.textContent = data.skills || "Not provided";
            pExperience.textContent = data.experience || "0";
            pEducation.textContent = data.education || "Not provided";
            profileForm.style.display = "none";
            viewProfile.style.display = "block";
          } else {
            profileForm.style.display = "block";
            viewProfile.style.display = "none";
          }
        } catch (err) {
          console.error('Error fetching profile:', err);
        }
      });

      profileForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const profileData = {
          name: document.getElementById("profileName").value.trim(),
          phone: document.getElementById("profilePhone").value.trim(),
          skills: document.getElementById("profileSkills").value.trim(),
          experience: document.getElementById("profileExperience").value.trim(),
          education: document.getElementById("profileEducation").value.trim()
        };

        try {
          const res = await fetch(`${API_BASE}/users/profile`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
            body: JSON.stringify(profileData)
          });

          const data = await res.json();
          if (res.ok) {
            alert("Profile saved!");
            pName.textContent = data.name;
            pEmail.textContent = data.email || currentUserEmail;
            pPhone.textContent = data.phone || "Not provided";
            pSkills.textContent = data.skills || "Not provided";
            pExperience.textContent = data.experience || "0";
            pEducation.textContent = data.education || "Not provided";
            profileForm.style.display = "none";
            viewProfile.style.display = "block";
          } else {
            alert(data.message || "Failed to save profile");
          }
        } catch (err) {
          console.error('Error saving profile:', err);
        }
      });

      document.getElementById("editProfileBtn").addEventListener("click", async () => {
        profileForm.style.display = "block";
        viewProfile.style.display = "none";
      });

      // === JOBS SECTION ===
      fetch(`${API_BASE}/jobs`, {
        headers: { 'Authorization': `Bearer ${token}` }
      })
      .then(res => res.json())
      .then(jobs => {
        allJobs = jobs;
        renderJobs(allJobs);
      })
      .catch(err => {
        console.error('Error fetching jobs:', err);
        document.getElementById('jobsList').innerHTML = '<p>Error loading jobs.</p>';
      });

      // View Applications
      document.getElementById("viewApplicationsBtn").addEventListener("click", async () => {
        try {
          const res = await fetch(`${API_BASE}/applications/my-applications`, {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          const applications = await res.json();
          const list = document.getElementById("applicationsList");
          list.innerHTML = "";

          if (!applications.length) list.innerHTML = "<p>No applications found.</p>";
          else {
            applications.forEach(app => {
              const div = document.createElement("div");
              div.classList.add("job-card");
              div.innerHTML = `
                <h3>${app.job.title}</h3>
                <p><strong>${app.job.company}</strong> - ${app.job.location}</p>
                <p><em>Cover Letter:</em> ${app.coverLetter}</p>
                <p><strong>Status:</strong> ${app.status}</p>
              `;
              list.appendChild(div);
            });
          }
          document.getElementById("applicationsSection").style.display = "block";
        } catch (err) {
          console.error('Error fetching applications:', err);
        }
      });
    });

    function renderJobs(jobs) {
      const jobsList = document.getElementById('jobsList');
      jobsList.innerHTML = '';
      if (!jobs.length) { jobsList.innerHTML = '<p>No jobs available right now.</p>'; return; }

      const token = localStorage.getItem('token');
      const currentUserEmail = localStorage.getItem('currentUser');

      jobs.forEach(job => {
        const jobDiv = document.createElement('div');
        jobDiv.classList.add('job-card');
        jobDiv.innerHTML = `
          <h3>${job.title}</h3>
          <p><strong>${job.company}</strong> - ${job.location}</p>
          <p>${job.description}</p>
          <button onclick="applyJob('${job._id}')">Apply</button>
        `;
        jobsList.appendChild(jobDiv);
      });
    }

    async function applyJob(jobId) {
      const token = localStorage.getItem('token');
      if (!token) return alert('Login first');

      const coverLetter = prompt("Enter your cover letter:");
      if (!coverLetter) return;

      try {
        const res = await fetch(`${API_BASE}/applications`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
          body: JSON.stringify({ jobId, coverLetter })
        });
        const data = await res.json();
        if (res.ok) alert('Application submitted!');
        else alert(data.message || 'Failed to apply');
      } catch (err) {
        console.error('Error applying:', err);
      }
    }

    function filterJobs() {
      const search = document.getElementById("searchInput").value.toLowerCase();
      const location = document.getElementById("locationFilter").value.toLowerCase();
      const filtered = allJobs.filter(job => {
        const title = job.title?.toLowerCase() || "";
        const description = job.description?.toLowerCase() || "";
        const jobLocation = job.location?.toLowerCase() || "";
        return (title.includes(search) || description.includes(search)) &&
               (location === "" || jobLocation.includes(location));
      });
      renderJobs(filtered);
    }

    function closeApplications() { document.getElementById("applicationsSection").style.display = "none"; }
  </script>
</body>
</html>
