<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Employer Dashboard - Job Portal</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .job-card { border: 1px solid #ccc; padding: 10px; margin: 10px 0; border-radius: 5px; }
    .top-right-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      padding: 8px 12px;
      border: none;
      border-radius: 6px;
      background: #007bff;
      color: white;
      cursor: pointer;
    }
    .top-right-btn:hover { background: #0056b3; }

    #applicationsModal, #profileModal {
      display: none;
      position: fixed;
      top: 10%;
      left: 50%;
      transform: translateX(-50%);
      background: #fff;
      padding: 20px;
      border: 1px solid #aaa;
      border-radius: 8px;
      width: 50%;
      max-height: 70vh;
      overflow-y: auto;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      z-index: 1000;
    }
    .btn { padding: 6px 10px; margin: 2px; border: none; border-radius: 5px; cursor: pointer; }
    .btn-edit { background: #ffc107; }
    .btn-delete { background: #dc3545; color: white; }
    .btn-filled { background: #28a745; color: white; }
  </style>
</head>
<body>
  <h1>Employer Dashboard</h1>
  <button id="logoutBtn">Logout</button>
  <button id="myProfileBtn" class="top-right-btn">My Profile</button>

  <!-- Post Job Form -->
  <section id="postJobSection">
    <h2>Post a New Job</h2>
    <form id="postJobForm">
      <input type="text" id="title" placeholder="Job Title" required>
      <input type="text" id="company" placeholder="Company Name" required>
      <input type="text" id="location" placeholder="Location" required>
      <textarea id="description" placeholder="Job Description" required></textarea>
      <button type="submit">Post Job</button>
    </form>
  </section>

  <hr>

  <!-- Employer's Jobs -->
  <section>
    <h2>My Posted Jobs</h2>
    <div id="myJobsList"></div>
  </section>

  <!-- Applications Modal -->
  <div id="applicationsModal">
    <h2>Applications for this Job</h2>
    <div id="applicationsContainer"></div>
    <button onclick="closeApplications()">Close</button>
  </div>

  <!-- Profile Modal -->
  <div id="profileModal">
    <h2>My Profile</h2>
    <div id="profileContainer"></div>
    <button onclick="closeProfile()">Close</button>
  </div>

  <script>
    let currentUserEmail = localStorage.getItem("currentUser");
    const token = localStorage.getItem("token");

    if (!token || !currentUserEmail) {
      window.location.href = "login.html";
    }

    // Logout
    document.getElementById("logoutBtn").addEventListener("click", () => {
      localStorage.removeItem("token");
      localStorage.removeItem("currentUser");
      localStorage.removeItem("role");
      localStorage.removeItem("name");
      window.location.href = "login.html";
    });

    // Post Job
    document.getElementById("postJobForm").addEventListener("submit", (e) => {
      e.preventDefault();

      const title = document.getElementById("title").value.trim();
      const company = document.getElementById("company").value.trim();
      const location = document.getElementById("location").value.trim();
      const description = document.getElementById("description").value.trim();

      fetch("http://localhost:5000/api/jobs", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": token.startsWith("Bearer ") ? token : `Bearer ${token}`
        },
        body: JSON.stringify({ title, company, location, description })
      })
      .then(res => res.json())
      .then(data => {
        alert(data.message || "Job posted successfully!");
        loadMyJobs();
      })
      .catch(err => console.error("Error posting job:", err));
    });

    // Load Employer Jobs
    function loadMyJobs() {
      fetch("http://localhost:5000/api/jobs", {
        method: "GET",
        headers: {
          "Authorization": token.startsWith("Bearer ") ? token : `Bearer ${token}`
        }
      })
      .then(res => res.json())
      .then(jobs => {
        const jobList = Array.isArray(jobs) ? jobs : [];

        const myJobs = jobList.filter(job => {
          if (!job.employer) return false;
          if (typeof job.employer === "object" && job.employer.email) {
            return job.employer.email === currentUserEmail;
          }
          return false;
        });

        renderMyJobs(myJobs);
      })
      .catch(err => console.error("Error fetching jobs:", err));
    }

    // Render Employer Jobs
    function renderMyJobs(jobs) {
      const list = document.getElementById("myJobsList");
      list.innerHTML = "";

      if (!jobs.length) {
        list.innerHTML = "<p>No jobs posted yet.</p>";
        return;
      }

      jobs.forEach(job => {
        const div = document.createElement("div");
        div.classList.add("job-card");
        div.innerHTML = `
          <h3>${job.title} (${job.status || "Open"})</h3>
          <p><strong>${job.company}</strong> - ${job.location}</p>
          <p>${job.description}</p>
          <button class="btn btn-edit" onclick="editJob('${job._id}', '${job.title}', '${job.company}', '${job.location}', '${job.description}')">Edit</button>
          <button class="btn btn-delete" onclick="deleteJob('${job._id}')">Delete</button>
          <button class="btn btn-filled" onclick="markFilled('${job._id}')">Mark Filled</button>
          <button onclick="viewApplications('${job._id}')">View Applications</button>
        `;
        list.appendChild(div);
      });
    }

    // Edit Job
    function editJob(jobId, title, company, location, description) {
      const newTitle = prompt("Edit Job Title:", title);
      const newCompany = prompt("Edit Company:", company);
      const newLocation = prompt("Edit Location:", location);
      const newDescription = prompt("Edit Description:", description);

      if (!newTitle || !newCompany || !newLocation || !newDescription) return;

      fetch(`http://localhost:5000/api/jobs/${jobId}`, {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
          "Authorization": token.startsWith("Bearer ") ? token : `Bearer ${token}`
        },
        body: JSON.stringify({ title: newTitle, company: newCompany, location: newLocation, description: newDescription })
      })
      .then(res => res.json())
      .then(() => {
        alert("Job updated!");
        loadMyJobs();
      })
      .catch(err => console.error("Error editing job:", err));
    }

    // Delete Job
    function deleteJob(jobId) {
      if (!confirm("Are you sure you want to delete this job?")) return;

      fetch(`http://localhost:5000/api/jobs/${jobId}`, {
        method: "DELETE",
        headers: {
          "Authorization": token.startsWith("Bearer ") ? token : `Bearer ${token}`
        }
      })
      .then(res => res.json())
      .then(() => {
        alert("Job deleted!");
        loadMyJobs();
      })
      .catch(err => console.error("Error deleting job:", err));
    }

    // Mark Job as Filled
    function markFilled(jobId) {
      fetch(`http://localhost:5000/api/jobs/${jobId}`, {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
          "Authorization": token.startsWith("Bearer ") ? token : `Bearer ${token}`
        },
        body: JSON.stringify({ status: "Filled" })
      })
      .then(res => res.json())
      .then(() => {
        alert("Job marked as filled!");
        loadMyJobs();
      })
      .catch(err => console.error("Error marking filled:", err));
    }

    // View Applications
    function viewApplications(jobId) {
      const apps = JSON.parse(localStorage.getItem("applications_all")) || [];
      const jobApps = apps.filter(app => app.jobId === jobId);

      const container = document.getElementById("applicationsContainer");
      container.innerHTML = "";

      if (!jobApps.length) {
        container.innerHTML = "<p>No applications yet.</p>";
      } else {
        jobApps.forEach(app => {
          const div = document.createElement("div");
          div.classList.add("job-card");
          div.innerHTML = `
            <p><strong>Applicant:</strong> ${app.userEmail}</p>
            <p><strong>Job Title:</strong> ${app.title}</p>
            <p><strong>Company:</strong> ${app.company}</p>
            <p><strong>Cover Letter:</strong> ${app.coverLetter}</p>
          `;
          container.appendChild(div);
        });
      }

      document.getElementById("applicationsModal").style.display = "block";
    }

    function closeApplications() {
      document.getElementById("applicationsModal").style.display = "none";
    }

    // Profile Modal (Name, Email, Role)
    document.getElementById("myProfileBtn").addEventListener("click", () => {
      const users = JSON.parse(localStorage.getItem("users")) || {};
      const profile = users[currentUserEmail]?.profile || {};
      const container = document.getElementById("profileContainer");
      container.innerHTML = `
        <p><strong>Name:</strong> ${profile.name || "Not set"}</p>
        <p><strong>Email:</strong> ${currentUserEmail}</p>
        <p><strong>Role:</strong> employer</p>
      `;
      document.getElementById("profileModal").style.display = "block";
    });

    function closeProfile() {
      document.getElementById("profileModal").style.display = "none";
    }

    // Initial load
    loadMyJobs();
  </script>
</body>
</html>
